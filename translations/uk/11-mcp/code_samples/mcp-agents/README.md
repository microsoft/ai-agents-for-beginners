<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "5cc6836626047aa055e8960c8484a7d0",
  "translation_date": "2025-07-24T10:19:01+00:00",
  "source_file": "11-mcp/code_samples/mcp-agents/README.md",
  "language_code": "uk"
}
-->
# Побудова систем комунікації агент-агент за допомогою MCP

> Коротко - Чи можна створити комунікацію Agent2Agent на MCP? Так!

MCP значно розвинувся за межі своєї початкової мети "надання контексту для LLM". Завдяки останнім вдосконаленням, таким як [відновлювані потоки](https://modelcontextprotocol.io/docs/concepts/transports#resumability-and-redelivery), [елісітація](https://modelcontextprotocol.io/specification/2025-06-18/client/elicitation), [семплінг](https://modelcontextprotocol.io/specification/2025-06-18/client/sampling) і сповіщення ([прогрес](https://modelcontextprotocol.io/specification/2025-06-18/basic/utilities/progress) та [ресурси](https://modelcontextprotocol.io/specification/2025-06-18/schema#resourceupdatednotification)), MCP тепер забезпечує надійну основу для створення складних систем комунікації агент-агент.

## Неправильне уявлення про агента/інструмент

Зі зростанням інтересу розробників до інструментів із агентною поведінкою (тривала робота, необхідність додаткового вводу під час виконання тощо) поширюється хибне уявлення, що MCP не підходить для цього, оскільки ранні приклади його примітивів інструментів зосереджувалися на простих шаблонах запит-відповідь.

Це уявлення застаріле. Специфікація MCP значно вдосконалена за останні місяці, щоб закрити прогалини для створення тривалої агентної поведінки:

- **Потокова передача та часткові результати**: Оновлення прогресу в реальному часі під час виконання
- **Відновлюваність**: Клієнти можуть перепідключатися та продовжувати після розриву з'єднання
- **Стійкість**: Результати зберігаються після перезапуску сервера (наприклад, через посилання на ресурси)
- **Багатокроковість**: Інтерактивний ввід під час виконання через елісітацію та семплінг

Ці функції можна комбінувати для створення складних агентних і мультиагентних застосунків, які розгортаються на основі протоколу MCP.

Для довідки, ми будемо називати агента "інструментом", доступним на сервері MCP. Це передбачає існування хост-застосунку, який реалізує клієнт MCP, встановлює сесію із сервером MCP і може викликати агента.

## Що робить інструмент MCP "агентним"?

Перш ніж перейти до реалізації, визначимо, які інфраструктурні можливості потрібні для підтримки тривалих агентів.

> Ми визначимо агента як сутність, яка може працювати автономно протягом тривалого часу, здатну виконувати складні завдання, що можуть вимагати багаторазових взаємодій або коригувань на основі зворотного зв'язку в реальному часі.

### 1. Потокова передача та часткові результати

Традиційні шаблони запит-відповідь не працюють для тривалих завдань. Агенти повинні надавати:

- Оновлення прогресу в реальному часі
- Проміжні результати

**Підтримка MCP**: Сповіщення про оновлення ресурсів дозволяють потокову передачу часткових результатів, хоча це вимагає ретельного проєктування, щоб уникнути конфліктів із моделлю 1:1 запит/відповідь JSON-RPC.

| Функція                    | Використання                                                                                                                                                                       | Підтримка MCP                                                                                |
| -------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------ |
| Оновлення прогресу в реальному часі | Користувач запитує завдання міграції кодової бази. Агент передає прогрес: "10% - Аналіз залежностей... 25% - Конвертація файлів TypeScript... 50% - Оновлення імпортів..."          | ✅ Сповіщення про прогрес                                                                  |
| Часткові результати            | Завдання "Згенерувати книгу" передає часткові результати, наприклад: 1) План сюжету, 2) Список розділів, 3) Кожен завершений розділ. Хост може перевірити, скасувати або перенаправити на будь-якому етапі. | ✅ Сповіщення можуть бути "розширені", щоб включати часткові результати, див. пропозиції PR 383, 776 |

<div align="center" style="font-style: italic; font-size: 0.95em; margin-bottom: 0.5em;">
<strong>Рисунок 1:</strong> Ця діаграма ілюструє, як агент MCP передає оновлення прогресу в реальному часі та часткові результати хост-застосунку під час тривалого завдання, дозволяючи користувачеві відстежувати виконання в реальному часі.
</div>

```mermaid
sequenceDiagram
    participant User
    participant Host as Host App<br/>(MCP Client)
    participant Server as MCP Server<br/>(Agent Tool)

    User->>Host: Start long task
    Host->>Server: Call agent_tool()

    loop Progress Updates
        Server-->>Host: Progress + partial results
        Host-->>User: Stream updates
    end

    Server-->>Host: ✅ Final result
    Host-->>User: Complete
```

### 2. Відновлюваність

Агенти повинні обробляти розриви мережі без втрати даних:

- Перепідключення після розриву з'єднання (з боку клієнта)
- Продовження з того місця, де вони зупинилися (повторна доставка повідомлень)

**Підтримка MCP**: Транспорт StreamableHTTP MCP сьогодні підтримує відновлення сесій і повторну доставку повідомлень за допомогою ідентифікаторів сесій і останніх ідентифікаторів подій. Важливо зазначити, що сервер повинен реалізувати EventStore, який дозволяє відтворення подій при перепідключенні клієнта.  
Зверніть увагу, що існує пропозиція спільноти (PR #975), яка досліджує транспортно-незалежні відновлювані потоки.

| Функція      | Використання                                                                                                                                                   | Підтримка MCP                                                                |
| ------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------- |
| Відновлюваність | Клієнт розриває з'єднання під час тривалого завдання. Після перепідключення сесія відновлюється з відтворенням пропущених подій, продовжуючи безперервно з того місця, де зупинилася. | ✅ Транспорт StreamableHTTP з ідентифікаторами сесій, відтворенням подій і EventStore |

<div align="center" style="font-style: italic; font-size: 0.95em; margin-bottom: 0.5em;">
<strong>Рисунок 2:</strong> Ця діаграма показує, як транспорт StreamableHTTP MCP і EventStore забезпечують безперервне відновлення сесії: якщо клієнт розриває з'єднання, він може перепідключитися і відтворити пропущені події, продовжуючи завдання без втрати прогресу.
</div>

```mermaid
sequenceDiagram
    participant User
    participant Host as Host App<br/>(MCP Client)
    participant Server as MCP Server<br/>(Agent Tool)
    participant Store as Event Store

    User->>Host: Start task
    Host->>Server: Call tool [session: abc123]
    Server->>Store: Save events

    Note over Host,Server: 💥 Connection lost

    Host->>Server: Reconnect [session: abc123]
    Store-->>Server: Replay events
    Server-->>Host: Catch up + continue
    Host-->>User: ✅ Complete
```

### 3. Стійкість

Тривалі агенти потребують збереження стану:

- Результати зберігаються після перезапуску сервера
- Статус можна отримати поза сесією
- Відстеження прогресу між сесіями

**Підтримка MCP**: MCP тепер підтримує тип повернення Resource link для викликів інструментів. Сьогодні можливою схемою є проєктування інструменту, який створює ресурс і негайно повертає посилання на ресурс. Інструмент може продовжувати виконувати завдання у фоновому режимі та оновлювати ресурс. У свою чергу, клієнт може вибрати опитування стану цього ресурсу, щоб отримати часткові або повні результати (залежно від того, які оновлення ресурсу надає сервер) або підписатися на ресурс для отримання сповіщень про оновлення.

Одним із обмежень тут є те, що опитування ресурсів або підписка на оновлення можуть споживати ресурси, що має наслідки для масштабування. Існує відкрита пропозиція спільноти (включаючи #992), яка досліджує можливість включення вебхуків або тригерів, які сервер може викликати для сповіщення клієнта/хост-застосунку про оновлення.

| Функція    | Використання                                                                                                                                        | Підтримка MCP                                                        |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------ |
| Стійкість | Сервер аварійно завершує роботу під час завдання міграції даних. Результати та прогрес зберігаються після перезапуску, клієнт може перевірити статус і продовжити збережений ресурс. | ✅ Посилання на ресурси з постійним зберіганням і сповіщеннями про статус |

Сьогодні поширеним шаблоном є проєктування інструменту, який створює ресурс і негайно повертає посилання на ресурс. Інструмент може у фоновому режимі виконувати завдання, видавати сповіщення про ресурс, які слугують оновленнями прогресу або включають часткові результати, і оновлювати вміст у ресурсі за потреби.

<div align="center" style="font-style: italic; font-size: 0.95em; margin-bottom: 0.5em;">
<strong>Рисунок 3:</strong> Ця діаграма демонструє, як агенти MCP використовують постійні ресурси та сповіщення про статус, щоб забезпечити, що тривалі завдання зберігаються після перезапуску сервера, дозволяючи клієнтам перевіряти прогрес і отримувати результати навіть після збоїв.
</div>

```mermaid
sequenceDiagram
    participant User
    participant Host as Host App<br/>(MCP Client)
    participant Server as MCP Server<br/>(Agent Tool)
    participant DB as Persistent Storage

    User->>Host: Start task
    Host->>Server: Call tool
    Server->>DB: Create resource + updates
    Server-->>Host: 🔗 Resource link

    Note over Server: 💥 Server restart

    User->>Host: Check status
    Host->>Server: Get resource
    Server->>DB: Load state
    Server-->>Host: Current progress
    Server->>DB: Complete + notify
    Host-->>User: ✅ Complete
```

### 4. Багатокрокові взаємодії

Агенти часто потребують додаткового вводу під час виконання:

- Уточнення або підтвердження від людини
- Допомога ШІ для складних рішень
- Динамічне налаштування параметрів

**Підтримка MCP**: Повністю підтримується через семплінг (для вводу ШІ) та елісітацію (для вводу людини).

| Функція                 | Використання                                                                                                                                     | Підтримка MCP                                           |
| ----------------------- | -------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------- |
| Багатокрокові взаємодії | Агент бронювання подорожей запитує підтвердження ціни у користувача, потім просить ШІ підсумувати дані про подорож перед завершенням транзакції. | ✅ Елісітація для вводу людини, семплінг для вводу ШІ |

<div align="center" style="font-style: italic; font-size: 0.95em; margin-bottom: 0.5em;">
<strong>Рисунок 4:</strong> Ця діаграма показує, як агенти MCP можуть інтерактивно запитувати ввід людини або допомогу ШІ під час виконання, підтримуючи складні багатокрокові робочі процеси, такі як підтвердження та динамічне прийняття рішень.
</div>

```mermaid
sequenceDiagram
    participant User
    participant Host as Host App<br/>(MCP Client)
    participant Server as MCP Server<br/>(Agent Tool)

    User->>Host: Book flight
    Host->>Server: Call travel_agent

    Server->>Host: Elicitation: "Confirm $500?"
    Note over Host: Elicitation callback (if available)
    Host->>User: 💰 Confirm price?
    User->>Host: "Yes"
    Host->>Server: Confirmed

    Server->>Host: Sampling: "Summarize data"
    Note over Host: AI callback (if available)
    Host->>Server: Report summary

    Server->>Host: ✅ Flight booked
```

...

**Відмова від відповідальності**:  
Цей документ було перекладено за допомогою сервісу автоматичного перекладу [Co-op Translator](https://github.com/Azure/co-op-translator). Хоча ми прагнемо до точності, будь ласка, майте на увазі, що автоматичні переклади можуть містити помилки або неточності. Оригінальний документ на його рідній мові слід вважати авторитетним джерелом. Для критичної інформації рекомендується професійний людський переклад. Ми не несемо відповідальності за будь-які непорозуміння або неправильні тлумачення, що виникли внаслідок використання цього перекладу.